<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand's Stories - Chat with Benn Cortigan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=Special+Elite&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Crimson Pro', serif;
        }

        :root {
            --parchment: #f5f1e8;
            --ink-dark: #2c2416;
            --ink-light: #5d5340;
            --accent-gold: #b8860b;
            --accent-rust: #8b4513;
            --wood-light: #d2b48c;
            --wood-dark: #8b7355;
            --shadow-heavy: rgba(0, 0, 0, 0.2);
            --shadow-light: rgba(0, 0, 0, 0.08);
            --success-green: #2e7d32;
            --warning-amber: #ff8f00;
        }

        body {
            background: linear-gradient(135deg, #1a1200 0%, #3d2c1d 100%);
            color: var(--ink-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(184, 134, 11, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 69, 19, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header-container {
            background: linear-gradient(to right, var(--wood-dark), var(--wood-light));
            padding: 30px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 8px 32px var(--shadow-heavy);
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(139, 69, 19, 0.3);
        }

        .header-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%238b4513' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;
            pointer-events: none;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-icon {
            font-size: 3rem;
            color: var(--accent-gold);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .logo-text {
            text-align: center;
        }

        h1 {
            font-family: 'Special Elite', cursive;
            font-size: 3.5rem;
            color: white;
            text-shadow: 2px 2px 4px var(--shadow-heavy);
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.4rem;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            border-left: 3px solid var(--accent-gold);
        }

        /* Auth Section */
        .auth-section {
            background: var(--parchment);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 6px 20px var(--shadow-light);
            border: 1px solid var(--wood-light);
            position: relative;
            overflow: hidden;
        }

        .auth-section::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 98%, rgba(184, 134, 11, 0.1) 100%);
            pointer-events: none;
        }

        .auth-info {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(210, 180, 140, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--accent-gold);
        }

        .auth-info i {
            color: var(--accent-gold);
            font-size: 1.3rem;
            margin-top: 2px;
        }

        .auth-info span {
            flex: 1;
            font-size: 1.05rem;
            color: var(--ink-light);
        }

        .auth-form {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .auth-form input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--wood-light);
            border-radius: 8px;
            font-size: 1.1rem;
            background: white;
            transition: all 0.3s;
            box-shadow: inset 0 2px 4px var(--shadow-light);
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.2);
        }

        .auth-form button {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--accent-rust), var(--accent-gold));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px var(--shadow-heavy);
        }

        .auth-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow-heavy);
            background: linear-gradient(135deg, #6b3410, #a07800);
        }

        .auth-form button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Main Chat Interface */
        .chat-container {
            flex: 1;
            display: none;
            background: var(--parchment);
            border-radius: 15px;
            box-shadow: 0 8px 32px var(--shadow-heavy);
            overflow: hidden;
            border: 1px solid var(--wood-light);
            position: relative;
        }

        .chat-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%238b4513' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.4;
            pointer-events: none;
        }

        /* Sidebar */
        .chats-sidebar {
            background: linear-gradient(180deg, #f0e6d2 0%, #e8ddc8 100%);
            padding: 25px;
            width: 320px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--wood-light);
            position: relative;
            z-index: 1;
        }

        .chats-header {
            font-family: 'Special Elite', cursive;
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--accent-rust);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--wood-light);
        }

        .chat-count {
            background: var(--accent-gold);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }

        .chats-list::-webkit-scrollbar {
            width: 6px;
        }

        .chats-list::-webkit-scrollbar-track {
            background: rgba(210, 180, 140, 0.3);
            border-radius: 3px;
        }

        .chats-list::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 3px;
        }

        .chat-item {
            padding: 18px;
            margin-bottom: 12px;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.3s;
            box-shadow: 0 2px 8px var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .chat-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px var(--shadow-heavy);
            border-left-color: var(--accent-gold);
        }

        .chat-item.active {
            background: linear-gradient(135deg, #fff8e1, #f5f1e8);
            border-left-color: var(--accent-rust);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.2);
        }

        .chat-item::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(184, 134, 11, 0.3), transparent);
        }

        .chat-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1rem;
            color: var(--ink-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-preview {
            font-size: 0.95rem;
            color: var(--ink-light);
            margin-bottom: 8px;
            line-height: 1.4;
            max-height: 2.8em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .chat-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #888;
        }

        .chat-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-message-count {
            background: rgba(184, 134, 11, 0.1);
            color: var(--accent-gold);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .new-chat-btn {
            background: linear-gradient(135deg, var(--accent-rust), var(--accent-gold));
            color: white;
            border: none;
            padding: 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 6px var(--shadow-heavy);
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow-heavy);
            background: linear-gradient(135deg, #6b3410, #a07800);
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, var(--parchment) 0%, #f9f5eb 100%);
            position: relative;
            z-index: 1;
        }

        .chat-header {
            padding: 20px 30px;
            background: linear-gradient(90deg, #f0e6d2 0%, #e8ddc8 100%);
            border-bottom: 1px solid var(--wood-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .chat-title-display {
            font-family: 'Special Elite', cursive;
            font-size: 1.8rem;
            color: var(--accent-rust);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .character-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 2px 8px var(--shadow-light);
            border: 1px solid var(--wood-light);
        }

        .user-info i {
            color: var(--accent-gold);
            font-size: 1.2rem;
        }

        .user-email {
            font-weight: 600;
            color: var(--ink-dark);
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--wood-light);
            color: var(--ink-light);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(139, 69, 19, 0.1);
            border-color: var(--accent-rust);
        }

        /* Messages */
        .chat-messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(210, 180, 140, 0.2);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 4px;
        }

        .message {
            max-width: 75%;
            padding: 20px 25px;
            border-radius: 20px;
            line-height: 1.6;
            position: relative;
            animation: fadeInUp 0.5s ease-out;
            box-shadow: 0 3px 12px var(--shadow-light);
            border: 1px solid transparent;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, #e8f0fe, #d0e1fd);
            border-bottom-right-radius: 5px;
            border: 1px solid rgba(64, 128, 255, 0.2);
            margin-left: auto;
        }

        .message-user::before {
            content: "âœ“";
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--success-green);
            font-size: 0.9rem;
            opacity: 0;
            animation: fadeIn 0.3s 0.5s forwards;
        }

        .message-benn {
            align-self: flex-start;
            background: linear-gradient(135deg, #f9f3e9, #ede4d4);
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(139, 69, 19, 0.2);
            margin-right: auto;
        }

        .message-benn::before {
            content: "ðŸ‘´";
            position: absolute;
            left: -40px;
            top: 10px;
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .message-header {
            font-family: 'Special Elite', cursive;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1rem;
            color: var(--accent-rust);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .message-sentiment {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(184, 134, 11, 0.1);
            color: var(--accent-gold);
        }

        .message-content {
            font-size: 1.05rem;
            color: var(--ink-dark);
            line-height: 1.6;
        }

        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 0.85rem;
        }

        .message-time {
            color: #888;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .memory-badge {
            background: rgba(46, 125, 50, 0.1);
            color: var(--success-green);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .depth-badge {
            background: rgba(255, 143, 0, 0.1);
            color: var(--warning-amber);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        /* Typing Indicator */
        .typing-indicator {
            padding: 15px 25px;
            align-self: flex-start;
            display: none;
            background: linear-gradient(135deg, #f9f3e9, #ede4d4);
            border-radius: 20px;
            border: 1px solid rgba(139, 69, 19, 0.2);
            margin: 10px;
            box-shadow: 0 3px 12px var(--shadow-light);
        }

        .typing-header {
            font-family: 'Special Elite', cursive;
            font-size: 0.9rem;
            color: var(--accent-rust);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .typing-dots {
            display: flex;
            gap: 8px;
        }

        .typing-dots span {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-gold);
            animation: typing 1.4s infinite both;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-12px); }
        }

        .typing-status {
            font-size: 0.9rem;
            color: var(--ink-light);
            font-style: italic;
        }

        /* Input Area */
        .chat-input-container {
            padding: 25px 30px;
            border-top: 1px solid var(--wood-light);
            background: linear-gradient(180deg, #f9f5eb 0%, #f0e6d2 100%);
            box-shadow: 0 -2px 8px var(--shadow-light);
            position: relative;
            z-index: 1;
        }

        .chat-input-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .chat-input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid var(--wood-light);
            border-radius: 15px;
            font-size: 1.05rem;
            resize: none;
            min-height: 80px;
            max-height: 200px;
            font-family: inherit;
            background: white;
            color: var(--ink-dark);
            line-height: 1.5;
            transition: all 0.3s;
            box-shadow: inset 0 2px 8px var(--shadow-light);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.2), inset 0 2px 8px var(--shadow-light);
        }

        .chat-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        .input-hint {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 0.8rem;
            color: #888;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .send-btn {
            padding: 18px 30px;
            background: linear-gradient(135deg, var(--accent-rust), var(--accent-gold));
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 8px var(--shadow-heavy);
            height: fit-content;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--shadow-heavy);
            background: linear-gradient(135deg, #6b3410, #a07800);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px var(--shadow-heavy);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--wood-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--ink-light);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            background: white;
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 25px;
            margin-top: 25px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            border-top: 1px solid rgba(139, 69, 19, 0.3);
            position: relative;
            z-index: 1;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 15px;
        }

        .footer-link {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-link:hover {
            color: var(--accent-gold);
        }

        /* Error & Loading States */
        .error {
            background: linear-gradient(135deg, #ffe6e6, #ffcccc);
            color: #cc0000;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
            border-left: 4px solid #cc0000;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .success {
            background: linear-gradient(135deg, #e6ffe6, #ccffcc);
            color: var(--success-green);
            padding: 15px 20px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
            border-left: 4px solid var(--success-green);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px;
            color: var(--ink-light);
            font-size: 1.1rem;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(184, 134, 11, 0.3);
            border-top: 4px solid var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: var(--ink-light);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--ink-dark);
        }

        /* Stats Panel */
        .stats-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px var(--shadow-heavy);
            border: 1px solid var(--wood-light);
            z-index: 100;
            display: none;
            min-width: 250px;
        }

        .stats-header {
            font-family: 'Special Elite', cursive;
            font-size: 1.2rem;
            color: var(--accent-rust);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--wood-light);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .stat-label {
            color: var(--ink-light);
        }

        .stat-value {
            font-weight: 600;
            color: var(--accent-gold);
        }

        .stat-bar {
            height: 6px;
            background: rgba(210, 180, 140, 0.3);
            border-radius: 3px;
            margin: 5px 0 15px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-rust));
            border-radius: 3px;
            transition: width 1s ease;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .container {
                padding: 15px;
            }
            
            .chat-container {
                flex-direction: column;
            }
            
            .chats-sidebar {
                width: 100%;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid var(--wood-light);
            }
            
            h1 {
                font-size: 2.8rem;
            }
            
            .logo-icon {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            .header-container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.2rem;
            }
            
            .tagline {
                font-size: 1rem;
                padding: 10px;
            }
            
            .auth-form {
                flex-direction: column;
            }
            
            .auth-form input,
            .auth-form button {
                width: 100%;
            }
            
            .chat-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .user-info {
                align-self: flex-end;
            }
            
            .message {
                max-width: 90%;
            }
            
            .message-benn::before {
                display: none;
            }
            
            .chat-input-form {
                flex-direction: column;
            }
            
            .send-btn {
                width: 100%;
                justify-content: center;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .logo {
                flex-direction: column;
                gap: 10px;
            }
            
            .chat-title-display {
                font-size: 1.4rem;
            }
            
            .message {
                padding: 15px;
            }
            
            .message-content {
                font-size: 1rem;
            }
        }

        /* Print Styles */
        @media print {
            .chat-container {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .chat-input-container,
            .chats-sidebar,
            .user-info,
            .logout-btn,
            .action-buttons,
            .footer {
                display: none;
            }
            
            .message {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-book-open logo-icon"></i>
                <div class="logo-text">
                    <h1>Grand's Stories</h1>
                    <p class="subtitle">Conversations with Benn Cortigan</p>
                </div>
            </div>
            <p class="tagline">
                Chat with the 92-year-old coding pioneer, war veteran, father of 22, and grandfather of 58. 
                He remembers the patterns in the noise and weaves them into wisdom.
            </p>
        </div>

        <!-- Auth Section -->
        <div class="auth-section" id="authSection">
            <div class="auth-info">
                <i class="fas fa-info-circle"></i>
                <span>
                    Enter your email to begin your conversation with Benn. Your chats are saved automatically 
                    and you can continue them anytime. No password required â€“ just pure, authentic conversation.
                </span>
            </div>
            <div class="auth-form">
                <input type="email" id="emailInput" placeholder="your.email@example.com" autocomplete="email">
                <button id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Begin Conversation
                </button>
            </div>
            <div id="authError" class="error"></div>
            <div id="authSuccess" class="success"></div>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel" id="statsPanel">
            <div class="stats-header">
                <i class="fas fa-chart-bar"></i> Conversation Stats
            </div>
            <div class="stat-item">
                <span class="stat-label">Conversation Depth:</span>
                <span class="stat-value" id="statDepth">0%</span>
            </div>
            <div class="stat-bar">
                <div class="stat-fill" id="depthBar" style="width: 0%"></div>
            </div>
            <div class="stat-item">
                <span class="stat-label">Memory Usage:</span>
                <span class="stat-value" id="statMemory">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Response Time:</span>
                <span class="stat-value" id="statResponseTime">0ms</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Emotional State:</span>
                <span class="stat-value" id="statEmotion">Neutral</span>
            </div>
        </div>

        <!-- Main Chat Interface -->
        <div class="chat-container" id="chatContainer">
            <!-- Sidebar -->
            <div class="chats-sidebar">
                <div class="chats-header">
                    <span><i class="fas fa-history"></i> Your Conversations</span>
                    <span class="chat-count" id="chatCount">0</span>
                </div>
                <div class="chats-list" id="chatsList">
                    <div class="loading" id="chatsLoading">
                        <div class="spinner"></div>
                        <span>Loading your conversations...</span>
                    </div>
                </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-plus-circle"></i> Start New Conversation
                </button>
            </div>
            
            <!-- Main Chat Area -->
            <div class="chat-main">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-title-display">
                        <i class="fas fa-user-tie character-icon"></i>
                        <span id="currentChatTitle">New Conversation with Benn</span>
                    </div>
                    <div class="user-info" id="userInfo">
                        <i class="fas fa-user-circle"></i>
                        <span class="user-email" id="userEmail"></span>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>
                </div>
                
                <!-- Messages -->
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state" id="welcomeEmpty">
                        <i class="fas fa-comments"></i>
                        <h3>Welcome to Your Conversation</h3>
                        <p>Start by typing a message below, or ask Benn about his family, his work, or life in general.</p>
                    </div>
                </div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-header">
                        <i class="fas fa-brain"></i>
                        Benn is thinking...
                    </div>
                    <div class="typing-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="typing-status" id="typingStatus">Accessing memory lattice...</span>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="chat-input-container">
                    <form class="chat-input-form" id="chatForm">
                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="messageInput" 
                                      placeholder="Ask Benn about his family, the war, his inventions, or anything else that comes to mind..." 
                                      rows="3"></textarea>
                            <div class="input-hint">
                                <span id="charCount">0</span>/1000 characters
                            </div>
                        </div>
                        <button type="submit" class="send-btn" id="sendBtn" disabled>
                            <i class="fas fa-paper-plane"></i> Send Message
                        </button>
                    </form>
                    <div class="action-buttons">
                        <button class="action-btn" id="clearBtn">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                        <button class="action-btn" id="suggestBtn">
                            <i class="fas fa-lightbulb"></i> Get Suggestions
                        </button>
                        <button class="action-btn" id="exportBtn">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="action-btn" id="statsBtn">
                            <i class="fas fa-chart-bar"></i> Stats
                        </button>
                    </div>
                    <div id="chatError" class="error" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-links">
                <a href="#" class="footer-link" id="privacyLink">Privacy</a>
                <a href="#" class="footer-link" id="aboutLink">About Benn</a>
                <a href="#" class="footer-link" id="techLink">Technology</a>
                <a href="#" class="footer-link" id="contactLink">Contact</a>
            </div>
            <p>Grand's Stories &copy; 2023 | A Quantum Conversation System with Persistent Memory</p>
            <p>Powered by the Memory Lattice &bull; No LLMs, just pattern recognition and wisdom</p>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            API_URL: '/api/chat', // Your backend API endpoint
            AUTH_API: '/api/auth', // You'll need to create this for Supabase auth
            MAX_MESSAGE_LENGTH: 1000,
            TYPING_INDICATORS: [
                "Accessing memory lattice...",
                "Analyzing semantic patterns...",
                "Consulting historical records...",
                "Synthesizing response...",
                "Polishing old memories..."
            ],
            SUGGESTED_QUESTIONS: [
                "Tell me about your family",
                "What was it like working with early computers?",
                "How did your experience in the Signal Corps shape you?",
                "What's the most important lesson you've learned?",
                "Tell me about the Memory Lattice project",
                "How do you see technology evolving?",
                "What advice would you give to young programmers?"
            ]
        };

        // ==================== STATE MANAGEMENT ====================
        class AppState {
            constructor() {
                this.currentUser = null;
                this.currentChatId = null;
                this.chats = [];
                this.currentMessages = [];
                this.isLoading = false;
                this.stats = {
                    totalMessages: 0,
                    conversationDepth: 0,
                    memoryReferences: 0,
                    averageResponseTime: 0,
                    emotionalState: 'neutral'
                };
                this.apiCalls = [];
                this.sessionStart = null;
            }

            // Store only minimal session info in localStorage
            init() {
                const session = localStorage.getItem('grandsSession');
                if (session) {
                    try {
                        const { userId, email, sessionId } = JSON.parse(session);
                        this.currentUser = { id: userId, email };
                        this.sessionStart = new Date();
                        return true;
                    } catch (e) {
                        localStorage.removeItem('grandsSession');
                    }
                }
                return false;
            }

            saveSession(userId, email, sessionId) {
                this.currentUser = { id: userId, email };
                this.sessionStart = new Date();
                localStorage.setItem('grandsSession', JSON.stringify({
                    userId,
                    email,
                    sessionId,
                    timestamp: Date.now()
                }));
            }

            clearSession() {
                this.currentUser = null;
                this.sessionStart = null;
                this.chats = [];
                this.currentMessages = [];
                this.currentChatId = null;
                localStorage.removeItem('grandsSession');
            }

            updateStats(metadata) {
                if (metadata) {
                    this.stats.conversationDepth = Math.round((metadata.conversationDepth || 0) * 100);
                    this.stats.memoryReferences = metadata.memoryReferences?.length || 0;
                    this.stats.emotionalState = metadata.emotionalState || 'neutral';
                    
                    if (this.apiCalls.length > 0) {
                        const recentCalls = this.apiCalls.slice(-10);
                        const avgTime = recentCalls.reduce((sum, call) => sum + call.duration, 0) / recentCalls.length;
                        this.stats.averageResponseTime = Math.round(avgTime);
                    }
                }
            }

            recordApiCall(duration) {
                this.apiCalls.push({
                    timestamp: Date.now(),
                    duration: duration
                });
                
                if (this.apiCalls.length > 100) {
                    this.apiCalls.shift();
                }
            }
        }

        // ==================== DOM ELEMENTS ====================
        const elements = {
            authSection: document.getElementById('authSection'),
            emailInput: document.getElementById('emailInput'),
            loginBtn: document.getElementById('loginBtn'),
            authError: document.getElementById('authError'),
            authSuccess: document.getElementById('authSuccess'),
            
            chatContainer: document.getElementById('chatContainer'),
            
            userEmail: document.getElementById('userEmail'),
            userInfo: document.getElementById('userInfo'),
            logoutBtn: document.getElementById('logoutBtn'),
            
            chatsList: document.getElementById('chatsList'),
            chatsLoading: document.getElementById('chatsLoading'),
            chatCount: document.getElementById('chatCount'),
            newChatBtn: document.getElementById('newChatBtn'),
            
            chatMessages: document.getElementById('chatMessages'),
            currentChatTitle: document.getElementById('currentChatTitle'),
            welcomeEmpty: document.getElementById('welcomeEmpty'),
            
            messageInput: document.getElementById('messageInput'),
            chatForm: document.getElementById('chatForm'),
            sendBtn: document.getElementById('sendBtn'),
            charCount: document.getElementById('charCount'),
            
            clearBtn: document.getElementById('clearBtn'),
            suggestBtn: document.getElementById('suggestBtn'),
            exportBtn: document.getElementById('exportBtn'),
            statsBtn: document.getElementById('statsBtn'),
            
            typingIndicator: document.getElementById('typingIndicator'),
            typingStatus: document.getElementById('typingStatus'),
            
            statsPanel: document.getElementById('statsPanel'),
            statDepth: document.getElementById('statDepth'),
            depthBar: document.getElementById('depthBar'),
            statMemory: document.getElementById('statMemory'),
            statResponseTime: document.getElementById('statResponseTime'),
            statEmotion: document.getElementById('statEmotion'),
            
            chatError: document.getElementById('chatError')
        };

        // ==================== APP INITIALIZATION ====================
        const appState = new AppState();
        let typingInterval = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (appState.init()) {
                showChatInterface();
            }

            setupEventListeners();
            updateCharCount();
        });

        function setupEventListeners() {
            elements.loginBtn.addEventListener('click', handleLogin);
            elements.emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin(e);
            });
            
            elements.chatForm.addEventListener('submit', handleSendMessage);
            elements.messageInput.addEventListener('input', handleInputChange);
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!elements.sendBtn.disabled) {
                        elements.chatForm.dispatchEvent(new Event('submit'));
                    }
                }
            });
            
            elements.newChatBtn.addEventListener('click', createNewChat);
            elements.logoutBtn.addEventListener('click', handleLogout);
            
            elements.clearBtn.addEventListener('click', () => {
                elements.messageInput.value = '';
                updateCharCount();
            });
            
            elements.suggestBtn.addEventListener('click', showSuggestions);
            elements.exportBtn.addEventListener('click', exportConversation);
            elements.statsBtn.addEventListener('click', toggleStatsPanel);
            
            document.addEventListener('click', (e) => {
                if (!elements.statsPanel.contains(e.target) && 
                    !elements.statsBtn.contains(e.target) &&
                    elements.statsPanel.style.display === 'block') {
                    elements.statsPanel.style.display = 'none';
                }
            });
        }

        // ==================== AUTH HANDLERS ====================
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = elements.emailInput.value.trim();
            if (!email || !email.includes('@')) {
                showError(elements.authError, 'Please enter a valid email address');
                return;
            }

            elements.loginBtn.disabled = true;
            elements.loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            
            try {
                // Call your backend auth endpoint
                const response = await fetch(CONFIG.AUTH_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });
                
                if (!response.ok) {
                    throw new Error(`Auth failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Save session
                appState.saveSession(data.userId, email, data.sessionId);
                
                // Initialize chat interface
                showChatInterface();
                
                // Load user's conversations
                await loadConversations();
                
                // Create initial chat if none exist
                if (appState.chats.length === 0) {
                    await createNewChat();
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showError(elements.authError, 'Failed to connect. Please try again.');
            } finally {
                elements.loginBtn.disabled = false;
                elements.loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Begin Conversation';
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to sign out? Your conversations are saved.')) {
                appState.clearSession();
                elements.authSection.style.display = 'block';
                elements.chatContainer.style.display = 'none';
                elements.emailInput.value = '';
                elements.authError.style.display = 'none';
                elements.authSuccess.style.display = 'none';
            }
        }

        // ==================== CHAT FUNCTIONS ====================
        async function loadConversations() {
            elements.chatsLoading.style.display = 'flex';
            
            try {
                // Fetch conversations from your API
                const response = await fetch(`${CONFIG.API_URL}/conversations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: appState.currentUser.id,
                        action: 'list'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    appState.chats = data.conversations || [];
                    renderConversationsList();
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                showError(elements.chatError, 'Failed to load conversations');
            } finally {
                elements.chatsLoading.style.display = 'none';
            }
        }

        function renderConversationsList() {
            elements.chatsList.innerHTML = '';
            elements.chatCount.textContent = appState.chats.length;
            
            if (appState.chats.length === 0) {
                elements.chatsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h3>No Conversations Yet</h3>
                        <p>Start your first conversation with Benn</p>
                    </div>
                `;
                return;
            }
            
            appState.chats.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
            
            appState.chats.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = `chat-item ${chat.id === appState.currentChatId ? 'active' : ''}`;
                chatElement.innerHTML = `
                    <div class="chat-title">
                        <i class="fas fa-comment"></i>
                        ${escapeHtml(chat.title || 'New Chat')}
                    </div>
                    <div class="chat-preview">${escapeHtml(chat.preview || 'Start chatting...')}</div>
                    <div class="chat-footer">
                        <div class="chat-date">
                            <i class="far fa-clock"></i>
                            ${formatDate(chat.updated_at)}
                        </div>
                        <div class="chat-message-count">
                            ${chat.message_count || 0} messages
                        </div>
                    </div>
                `;
                
                chatElement.addEventListener('click', () => {
                    loadChat(chat.id);
                });
                
                elements.chatsList.appendChild(chatElement);
            });
        }

        async function createNewChat() {
            try {
                const chatId = `chat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const newChat = {
                    id: chatId,
                    userId: appState.currentUser.id,
                    title: 'New Conversation with Benn',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    preview: 'Start chatting...',
                    message_count: 0
                };
                
                // Add to local state
                appState.chats.unshift(newChat);
                appState.currentChatId = chatId;
                appState.currentMessages = [];
                
                // Render
                renderConversationsList();
                clearChatMessages();
                
                // Add welcome message
                addWelcomeMessage();
                
                // Update UI
                elements.currentChatTitle.textContent = newChat.title;
                elements.welcomeEmpty.style.display = 'none';
                
            } catch (error) {
                console.error('Error creating chat:', error);
                showError(elements.chatError, 'Failed to create new chat');
            }
        }

        function addWelcomeMessage() {
            const welcomeMessage = {
                role: 'benn',
                content: "Ah, there you are. Come in, come in. My name's Benn. Benn Cortigan. Sit, if you can find a spot. The ears aren't what they were, but the mind's still sharp as a tack. Shame the body didn't get the memo. What's on your mind today?",
                created_at: new Date().toISOString(),
                metadata: {
                    sentiment: 'welcoming',
                    emotionalState: 'curious'
                }
            };
            
            addMessageToUI(welcomeMessage);
            appState.currentMessages.push(welcomeMessage);
        }

        async function loadChat(chatId) {
            try {
                elements.chatMessages.innerHTML = '<div class="loading"><div class="spinner"></div><span>Loading conversation...</span></div>';
                
                // Fetch chat messages from your API
                const response = await fetch(`${CONFIG.API_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: appState.currentUser.id,
                        chatId: chatId,
                        action: 'load'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    appState.currentChatId = chatId;
                    appState.currentMessages = data.messages || [];
                    
                    clearChatMessages();
                    
                    if (appState.currentMessages.length === 0) {
                        addWelcomeMessage();
                    } else {
                        appState.currentMessages.forEach(msg => addMessageToUI(msg));
                    }
                    
                    // Update chat title
                    const chat = appState.chats.find(c => c.id === chatId);
                    if (chat) {
                        elements.currentChatTitle.textContent = chat.title;
                    }
                    
                    renderConversationsList();
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Error loading chat:', error);
                showError(elements.chatError, 'Failed to load conversation');
            }
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            
            const message = elements.messageInput.value.trim();
            if (!message || message.length > CONFIG.MAX_MESSAGE_LENGTH) {
                showError(elements.chatError, `Message must be between 1 and ${CONFIG.MAX_MESSAGE_LENGTH} characters`);
                return;
            }

            // Add user message to UI
            const userMessage = {
                role: 'user',
                content: message,
                created_at: new Date().toISOString()
            };
            
            addMessageToUI(userMessage);
            appState.currentMessages.push(userMessage);
            
            // Clear input
            elements.messageInput.value = '';
            updateCharCount();
            elements.sendBtn.disabled = true;
            
            // Show typing indicator
            showTypingIndicator();
            scrollToBottom();
            
            const startTime = Date.now();
            
            try {
                // Call your backend API
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        userId: appState.currentUser.id,
                        chatId: appState.currentChatId,
                        action: 'chat'
                    })
                });
                
                const responseTime = Date.now() - startTime;
                appState.recordApiCall(responseTime);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add Benn's response
                const bennMessage = {
                    role: 'benn',
                    content: data.response,
                    created_at: new Date().toISOString(),
                    metadata: data.metadata || {}
                };
                
                addMessageToUI(bennMessage, data.metadata);
                appState.currentMessages.push(bennMessage);
                
                // Update stats
                appState.updateStats(data.metadata);
                updateStatsDisplay();
                
                // Update chat in sidebar
                updateChatPreview(message, data.response);
                
            } catch (error) {
                console.error('Error sending message:', error);
                hideTypingIndicator();
                showError(elements.chatError, 'Connection error. Please try again.');
                
                // Fallback response
                const fallbackMessage = {
                    role: 'benn',
                    content: "Hmm, my connections aren't what they used to be. Let me think... Ah yes. The patterns in the noise. What were you asking about again?",
                    created_at: new Date().toISOString()
                };
                
                addMessageToUI(fallbackMessage);
                appState.currentMessages.push(fallbackMessage);
            } finally {
                scrollToBottom();
            }
        }

        function addMessageToUI(message, metadata = {}) {
            const messageElement = document.createElement('div');
            messageElement.className = `message message-${message.role}`;
            
            const time = formatTime(new Date(message.created_at));
            const sentiment = metadata.sentiment || 'neutral';
            const memoryRefs = metadata.memoryReferences || [];
            const depth = metadata.conversationDepth || 0;
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span>${message.role === 'user' ? 'You' : 'Benn Cortigan'}</span>
                    ${message.role === 'benn' ? `<span class="message-sentiment">${sentiment}</span>` : ''}
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
                <div class="message-footer">
                    <div class="message-time">
                        <i class="far fa-clock"></i>
                        ${time}
                    </div>
                    ${message.role === 'benn' ? `
                    <div class="message-meta">
                        ${memoryRefs.length > 0 ? `
                        <span class="memory-badge">
                            <i class="fas fa-brain"></i>
                            ${memoryRefs.length} memory${memoryRefs.length !== 1 ? 'ies' : ''}
                        </span>
                        ` : ''}
                        ${depth > 0.5 ? `
                        <span class="depth-badge">
                            <i class="fas fa-layer-group"></i>
                            Deep
                        </span>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
            
            elements.chatMessages.appendChild(messageElement);
            elements.welcomeEmpty.style.display = 'none';
        }

        function updateChatPreview(userMessage, bennResponse) {
            const chatIndex = appState.chats.findIndex(c => c.id === appState.currentChatId);
            if (chatIndex !== -1) {
                const chat = appState.chats[chatIndex];
                
                // Update title if it's still the default
                if (chat.title === 'New Conversation with Benn') {
                    chat.title = userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : '');
                    elements.currentChatTitle.textContent = chat.title;
                }
                
                // Update preview
                chat.preview = userMessage.substring(0, 50) + (userMessage.length > 50 ? '...' : '');
                chat.updated_at = new Date().toISOString();
                chat.message_count = (chat.message_count || 0) + 2;
                
                renderConversationsList();
            }
        }

        // ==================== UI HELPERS ====================
        function showChatInterface() {
            elements.authSection.style.display = 'none';
            elements.chatContainer.style.display = 'flex';
            elements.userEmail.textContent = appState.currentUser.email;
        }

        function clearChatMessages() {
            elements.chatMessages.innerHTML = '';
        }

        function showTypingIndicator() {
            let indicatorIndex = 0;
            elements.typingIndicator.style.display = 'block';
            elements.typingStatus.textContent = CONFIG.TYPING_INDICATORS[0];
            
            if (typingInterval) clearInterval(typingInterval);
            
            typingInterval = setInterval(() => {
                indicatorIndex = (indicatorIndex + 1) % CONFIG.TYPING_INDICATORS.length;
                elements.typingStatus.textContent = CONFIG.TYPING_INDICATORS[indicatorIndex];
            }, 2000);
            
            scrollToBottom();
        }

        function hideTypingIndicator() {
            if (typingInterval) clearInterval(typingInterval);
            elements.typingIndicator.style.display = 'none';
        }

        function scrollToBottom() {
            setTimeout(() => {
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }, 100);
        }

        function updateCharCount() {
            const count = elements.messageInput.value.length;
            elements.charCount.textContent = count;
            elements.charCount.style.color = count > CONFIG.MAX_MESSAGE_LENGTH ? '#cc0000' : '#888';
            elements.sendBtn.disabled = count === 0 || count > CONFIG.MAX_MESSAGE_LENGTH;
        }

        function handleInputChange() {
            updateCharCount();
            // Auto-resize textarea
            elements.messageInput.style.height = 'auto';
            elements.messageInput.style.height = Math.min(elements.messageInput.scrollHeight, 200) + 'px';
        }

        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function updateStatsDisplay() {
            elements.statDepth.textContent = `${appState.stats.conversationDepth}%`;
            elements.depthBar.style.width = `${appState.stats.conversationDepth}%`;
            elements.statMemory.textContent = appState.stats.memoryReferences;
            elements.statResponseTime.textContent = `${appState.stats.averageResponseTime}ms`;
            elements.statEmotion.textContent = capitalize(appState.stats.emotionalState);
        }

        function toggleStatsPanel() {
            if (elements.statsPanel.style.display === 'block') {
                elements.statsPanel.style.display = 'none';
            } else {
                updateStatsDisplay();
                elements.statsPanel.style.display = 'block';
            }
        }

        function showSuggestions() {
            const suggestions = CONFIG.SUGGESTED_QUESTIONS;
            const randomSuggestions = suggestions
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);
            
            const suggestionText = randomSuggestions.join('\n\n');
            
            if (elements.messageInput.value.trim() === '') {
                elements.messageInput.value = randomSuggestions[0];
            } else {
                elements.messageInput.value += '\n\nSuggested questions:\n' + suggestionText;
            }
            
            updateCharCount();
            handleInputChange();
        }

        function exportConversation() {
            const conversation = {
                user: appState.currentUser.email,
                title: elements.currentChatTitle.textContent,
                messages: appState.currentMessages,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(conversation, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `benn-conversation-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Initialize character count on load
        updateCharCount();
    </script>
</body>
</html>
